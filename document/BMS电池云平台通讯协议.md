# 通讯协议



目录

[TOC]



## 协议说明

- 协议版本：v1.0.2        协议版本代号：1
- 本协议用到的字段说明：

| Bit[n]  | 长度 | 代表n位比特 |
| ------- | ---- | ---------- |
| BYTE    | 1    | 1字节，8bit |
| BYTE[n] | n    | 代表n个字节 |
| WORD    | 2    | 16位整型    |
| DWORD   | 4    | 32位整型    |
| BCD     | n    | 8421bcd码   |
| ASCII   | n    | ASCII码     |

## 消息结构

消息结构有3部分构成： 消息头+消息体+校验位

| 消息头 | 消息体 | 校验位 |
| :----: | :----: | :----: |

#### 消息结构说明： 

- 消息头：消息头定义参见下表

  | 起始字节 | 字段 | 数据类型 | 描述                                                 |
  | -------- | -------- | -------- | -------- |
  | 0        | 消息ID     | WORD     | 消息ID：传递消息的类型                               |
  | 2        | 消息流水号 | WORD     | 设备联网成功后随机滚动，并在一段时间内确保不会重复。 |

  ----

- 消息体：详见各类型消息体的封装及字段


- 校验位：使用CRC16值作为校验位，校验范围为消息头+消息体，即消息的第一个字节至消息体最后一个字节。

#### 消息封装顺序：

消息头+消息体 --> CRC校验 --> 拼装校验位 --> 发送

#### 消息解析顺序：

取校验位 --> 校验消息正确性 --> 解析消息头 --> 解析消息体



------



## 消息体封装—设备端消息

### 设备通用应答 - 0x2701

> 消息ID：0x2701

| 字段       | 数据类型 | 说明                                                         |
| ---------- | -------- | ------------------------------------------------------------ |
| 应答流水号 | WORD     | 所应答消息的流水号                                           |
| 应答消息ID | WORD     | 应答的服务端消息对应的消息ID                                 |
| 应答结果   | BYTE     | 应答指令的结果，仅当结果0x01时代表成功，其他为具体消息定义的错误码 |

使用说明：用来应答服务器对应的指令执行结果，如对设备的控制，执行完成后设备需用此协议告知设备执行结果。具体应答方式会在服务器协议体现。



### 终端登录（设备基础信息）- 0x2702

> 消息 ID：0x2702

| 字段                | 数据类型  | 说明                                                         |
| ------------------- | :-------- | ------------------------------------------------------------ |
| 查询标记/回复消息ID | WORD | 当此消息为主动上报时，填充为0x0000，当此消息为查询回复时，填充服务器查询的消息流水号 |
| 制造商标识          | byte[2] | 设备生产商标识，用以区分生产厂商, byte[0]代表电池厂商标记，byte[1]代表保护板厂商标记，由小刀分配 |
| 硬件版本            | Ascii[8]  | 设备的硬件版本信息，8个字符                                  |
| 软件版本            | Ascii[8]  | 设备的软件版本，8个字符                                      |
| IMEI                | Ascii[15] | 设备IMEI号码 15字节                                          |
| ICCID               | Ascii[20] | 设备ICCID编码 20字节                                         |
| IMSI | Ascii[15] | IMSI编码 |
| 配置ID              | WORD      | 设备当前的配置ID，设备需保存此ID作为                         |
| 设备支持信息（预留）    | Bit[16]   | 设备支持信息，（预留）                                  |
| 协议版本            | WORD      | 协议版本编码，当前版本为1                                    |
| BMS软件版本         | Ascii[8]  | BMS软件版本，8个字符                                         |
| BMS硬件版本         | Ascii[8]  | BMS硬件版本信息，8个字符                                     |
| BMS编码 | Ascii[32] | BMS编码 |

**应答：**服务器端使用通用应答指令0Xa701

**使用说明：**

1. 主动上报：终端在断电重启时首次发送登录信息，终端登录如未收到 平台应答则延时 5 分钟再次登录，以后则倍增时间登录。

2. 平台查询：平台通过查询指令主动查询时上报。

## 消息体封装—平台端消息

### 平台通用应答 - 0xA701

> 0xA701

| 字段       | 数据类型 | 说明                                                         |
| ---------- | -------- | ------------------------------------------------------------ |
| 应答流水号 | WORD     | 所应答消息的流水号                                           |
| 应答消息ID | WORD     | 应答的服务端消息对应的消息ID                                 |
| 应答结果   | BYTE     | 应答指令的结果，仅当结果0x01时代表成功，其他为具体消息定义的错误码表 |

**使用说明：**用来应答设备端的指令，服务器端按照约定在收到设备上报的信息后用此消息回应，具体逻辑参见协议中的使用说明部分。

## MQTT通讯

### 说明：

1. 采用mqtt协议连接，mqtt协议版本3.1.1或以上

2. 接入方式：采用TLS1.2或TLS1.3加密方式接入mqtt服务器。客户端证书和域名会单独提供

3. 部分mqtt参数设置：
    (1). mqtt心跳包默认设置为120秒（keepalive参数）协议中不再定义心跳包，TCP断开检测使用mqtt自带的心跳检测；
    (2). CleanSession默认true（部分字段名称为CleanStart，设置true）； 

### TOPIC定义：

​		**TOPIC区分大小写，订阅和发布时统一使用大写。**

- 设备端订阅TOPIC规则：DEV/BMS/1/123456789ABCDEF

  以符号“/”切分为4个部分，每一部分说明如下，正常情况下前三部分不需要变更，只需要填充末尾的设备号。
  
  | 序号 | 标记 | 解释和示例 |
  | ---- | ------------------------ | ---- |
  | 1 | DEV | 第一部分：填充dev，代表设备客户端订阅标记 |
  | 2 | BMS | 第二部分：bms，代表客户端类为bms电池 |
  | 3 | 1 | 第三部分：协议版本代号，具体参见每版协议头部定义的版本代号 |
  | 4 | 123456789ABCDEF | 第三部分：设备号，填充当前设备的ID |
  



- 设备端发布TOPIC规则：SVC/BMS/1/123456789ABCDEF/2701

  以符号“/”切分为5个部分，每部分说明如下：

  | 序号 | 标记            | 解释和示例                                                   |
  | ---- | --------------- | ------------------------------------------------------------ |
  | 1    | SVC             | 第一部分：填充svc，服务器端用来订阅的标记                    |
  | 2    | BMS             | 第二部分：bms，代表客户端设备类型为bms电池                   |
  | 3    | 1               | 第三部分：通讯协议版本代号，具体参见每版协议头部定义的版本代号 |
  | 4    | 123456789ABCDEF | 第四部分：设备号，填充当前设备的ID                           |
  | 5    | 2701            | 第五部分：消息ID，用来区分不同的消息类型。例如0x2701         |





### MQTT账号密码：

​		客户端通过mqtt连接服务器时需要提供账号密码登录。采用一机一密的方式，用户名为当时设备号，密码在设备生产时写入到设备中。

